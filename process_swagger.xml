<?xml version="1.0" encoding="UTF-8"?><!--ant--><!--
	This file is part of the DITA-OT  Plug-in project.
	See the accompanying LICENSE file for applicable licenses.
-->
<project name="fox.jason.passthrough.swagger" xmlns:if="ant:if" xmlns:unless="ant:unless">

	<target name="swagger.prismjs.pre">
		<loadfile property="swagger.prismjs" srcFile="${dita.plugin.fox.jason.passthrough.swagger.dir}/resource/prism.js"/>
		<echo append="true" message="${line.separator}${swagger.prismjs}" file="${prismjs.temp.file}"/>
		<echo append="true" message=" or @format='swagger'" file="${prismjs.formats.temp.file}"/>
	</target>

	<target name="swagger.init">
		<condition property="is.html">
			<equals arg1="${out.ext}" arg2=".html"/>
	    </condition>
	</target>

	<target name="swagger.css">
		<copy if:set="is.html"  tofile="${output.dir}/swagger.css" file="${dita.plugin.fox.jason.passthrough.swagger.dir}${file.separator}resource/swagger.css"/>
	
	</target>

	<!--
		Create Swagger processing macros.
	-->
	<target name="swagger.process.pre" depends="swagger.init,swagger.css">
		<!--

			Entry point to the JavaScript tidier function which 
			removes HTML anchor tags and adds ids to headers

			@param file	- The Swagger Markdown file to clean up
		
		-->
		<scriptdef language="javascript" name="strip-swagger-anchors" src="${dita.plugin.fox.jason.passthrough.swagger.dir}/resource/strip-anchors.js">
			<attribute name="file"/>
		</scriptdef>
		<!--
			Individual file processing for swagger.
			Take an input format run swagger against it and convert to DITA

			@param src - The input file to convert to DITA
			@param dest - The output file location
			@param title - The title of the converted file
		-->
		<macrodef name="add-swagger-file">
			<attribute name="src" />
			<attribute name="dest" />
			<attribute name="title" />
			<sequential>
				<echo if:set="swagger.installed" taskname="swagger" level="info" message="Processing @{src}"/>

				<local name="swagger.temp.file"/>
				<tempfile deleteonexit="true" destdir="${dita.temp.dir}" 
					property="swagger.temp.file" suffix=""/>

				<java taskname="swagger" jar="${dita.plugin.fox.jason.passthrough.swagger.dir}/lib/swagger2markup-cli-1.3.3.jar"
					fork="true" failonerror="true" maxmemory="128m">
				  
					<arg value="convert"/>
					<arg value="-i"/>
					<arg value="@{src}"/>
					<arg value="-f"/>
					<arg value="${swagger.temp.file}"/>
					<arg value="-c"/>
					<arg value="${dita.plugin.fox.jason.passthrough.swagger.dir}/cfg/config.properties"/>
				</java>


				<strip-swagger-anchors file="${swagger.temp.file}.md"/>
				<copy file="${swagger.temp.file}.md" toFile="${output.dir}/Y.md"/>
				<add-pandoc-file src="${swagger.temp.file}.md" dest="@{dest}" title="@{title}"/>
			</sequential>
		</macrodef>
	</target>


	<!--
		Iterate across all files marked format="swagger" and process them
	-->
	<target name="swagger.process">
		<passthrough-iterate format="swagger" macro="add-swagger-file"/>
	</target>
</project>